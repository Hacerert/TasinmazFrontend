import { Component, OnInit, AfterViewInit } from '@angular/core';
import { Router } from '@angular/router';
import { TasinmazListDto, TasinmazService } from '../services/tasinmaz.service';
import { AuthService } from '../services/auth.service';
import { firstValueFrom } from 'rxjs';
import { DatePipe } from '@angular/common';
import * as XLSX from 'xlsx';
// OpenLayers imports
import Map from 'ol/Map';
import View from 'ol/View';
import TileLayer from 'ol/layer/Tile';
import VectorLayer from 'ol/layer/Vector';
import VectorSource from 'ol/source/Vector';
import OSM from 'ol/source/OSM';
import Feature from 'ol/Feature';
import { Polygon } from 'ol/geom';
import { transform } from 'ol/proj';
import { Style, Stroke, Fill } from 'ol/style';

@Component({
  selector: 'app-tasinmaz-list',
  templateUrl: './tasinmaz-list.component.html',
  styleUrls: ['./tasinmaz-list.component.css']
})
export class TasinmazListComponent implements OnInit, AfterViewInit {

  tasinmazlar: TasinmazListDto[] = [];
  filteredTasinmazlar: TasinmazListDto[] = [];
  loading: boolean = true;
  error: string | null = null;
  successMessage: string | null = null;
  selectedTasinmazIds: number[] = [];
  showModal: boolean = false;
  modalMessage: string = '';
  modalCallback: Function | null = null;

  // Kullanƒ±cƒ± rol√º kontrol√º
  isAdmin: boolean = false;
  userRole: string = '';

  // Filtreleme deƒüi≈ükenleri
  filterSehir: string = '';
  filterIlce: string = '';
  filterMahalle: string = '';
  filterTasinmazTuru: string = '';
  filterParselNumarasi: string = '';
  filterPaftaNumarasi: string = '';
  filterAdres: string = '';
  filterKoordinat: string = '';
  filterAda: string = '';

  // Dinamik filtre se√ßenekleri
  availableSehirler: string[] = [];
  availableIlceler: string[] = [];
  availableMahalleler: string[] = [];
  availableTurler: string[] = [];

  // Sayfalama deƒüi≈ükenleri
  currentPage: number = 1;
  itemsPerPage: number = 5; // Her sayfada 5 kayƒ±t
  
  // Math referansƒ± template'de kullanmak i√ßin
  Math = Math;

  // Map state
  listMap!: Map;
  listVectorSource!: VectorSource;
  listVectorLayer!: VectorLayer<VectorSource>;
  mapInitialized: boolean = false;

  constructor(
    private tasinmazService: TasinmazService,
    private router: Router,
    private authService: AuthService,
    private datePipe: DatePipe
  ) { }

  ngOnInit(): void {
    this.checkUserRole();
    this.getTasinmazlar();
  }

  ngAfterViewInit(): void {
    // map container render after view init
    setTimeout(() => this.initMap(), 0);
  }

  /**
   * Kullanƒ±cƒ± rol√ºn√º kontrol eder
   */
  checkUserRole(): void {
    this.userRole = this.authService.getUserRole() || '';
    this.isAdmin = this.userRole === 'Admin';
    console.log('üë§ Kullanƒ±cƒ± rol√º:', this.userRole, 'Admin mi:', this.isAdmin);
  }

  /**
   * Veritabanƒ±ndan t√ºm ta≈üƒ±nmazlarƒ± √ßeker.
   */
  getTasinmazlar(): void {
    this.loading = true;
    this.tasinmazService.getTasinmazlar().subscribe({
      next: (data) => {
        this.tasinmazlar = data;
        this.filteredTasinmazlar = [...data]; // Filtrelenmi≈ü listeyi ba≈ülat
        this.populateFilterOptions(); // Filtre se√ßeneklerini olu≈ütur
        this.loading = false;
        this.error = null;
        this.updateMapFeatures();
      },
      error: (e) => {
        this.error = 'Ta≈üƒ±nmazlar y√ºklenirken bir hata olu≈ütu.';
        this.loading = false;
        console.error(e);
      }
    });
  }

  /**
   * Mevcut ta≈üƒ±nmaz verilerine g√∂re filtre se√ßeneklerini olu≈ütur
   */
  populateFilterOptions(): void {
    // Benzersiz ≈üehirleri √ßƒ±kar (adres alanƒ±ndan)
    const sehirler = new Set<string>();
    const ilceler = new Set<string>();
    const mahalleler = new Set<string>();
    const turler = new Set<string>();

    this.tasinmazlar.forEach(tasinmaz => {
      // Adres alanƒ±ndan ≈üehir, il√ße, mahalle bilgisi √ßƒ±karmaya √ßalƒ±≈ü
      if (tasinmaz.adres) {
        const adresParts = tasinmaz.adres.split(' ');
        // Basit bir yakla≈üƒ±m - ger√ßek veride nasƒ±l formatlandƒ±ƒüƒ±na g√∂re ayarlanabilir
        if (adresParts.length > 0) {
          sehirler.add(adresParts[0]);
        }
        if (adresParts.length > 1) {
          ilceler.add(adresParts[1]);
        }
        if (adresParts.length > 2) {
          mahalleler.add(adresParts[2]);
        }
      }

      // Ada veya parsel bilgisinden t√ºr bilgisi √ßƒ±kar
      if (tasinmaz.ada) {
        turler.add(`Tip-${tasinmaz.ada}`);
      }
    });

    // Eƒüer yeterli veri yoksa, varsayƒ±lan deƒüerler ekle
    if (sehirler.size === 0) {
      this.availableSehirler = ['ƒ∞stanbul', 'Ankara', 'ƒ∞zmir'];
    } else {
      this.availableSehirler = Array.from(sehirler).sort();
    }

    if (ilceler.size === 0) {
      this.availableIlceler = ['Be≈üikta≈ü', 'Kadƒ±k√∂y', 'Ke√ßi√∂ren'];
    } else {
      this.availableIlceler = Array.from(ilceler).sort();
    }

    if (mahalleler.size === 0) {
      this.availableMahalleler = ['Levent', 'Etlik', 'Fenerbah√ße'];
    } else {
      this.availableMahalleler = Array.from(mahalleler).sort();
    }

    if (turler.size === 0) {
      this.availableTurler = ['deneme', 'deneme2', 'deneme3'];
    } else {
      this.availableTurler = Array.from(turler).sort();
    }

    console.log('Filtre se√ßenekleri olu≈üturuldu:', {
      sehirler: this.availableSehirler,
      ilceler: this.availableIlceler,
      mahalleler: this.availableMahalleler,
      turler: this.availableTurler
    });
  }

  /**
   * Filtreleri uygula
   */
  applyFilters(): void {
    let filtered = [...this.tasinmazlar];

    if (this.filterSehir) {
      filtered = filtered.filter(t => 
        t.adres && t.adres.toLowerCase().includes(this.filterSehir.toLowerCase())
      );
    }

    if (this.filterIlce) {
      filtered = filtered.filter(t => 
        t.adres && t.adres.toLowerCase().includes(this.filterIlce.toLowerCase())
      );
    }

    if (this.filterMahalle) {
      filtered = filtered.filter(t => 
        t.adres && t.adres.toLowerCase().includes(this.filterMahalle.toLowerCase())
      );
    }

    if (this.filterParselNumarasi) {
      filtered = filtered.filter(t => 
        t.parsel && t.parsel.toString().includes(this.filterParselNumarasi)
      );
    }

    if (this.filterPaftaNumarasi) {
      filtered = filtered.filter(t => 
        t.ada && t.ada.toString().includes(this.filterPaftaNumarasi)
      );
    }

    if (this.filterAdres) {
      filtered = filtered.filter(t => 
        t.adres && t.adres.toLowerCase().includes(this.filterAdres.toLowerCase())
      );
    }

    if (this.filterKoordinat) {
      filtered = filtered.filter(t => 
        t.koordinat && t.koordinat.toLowerCase().includes(this.filterKoordinat.toLowerCase())
      );
    }

    this.filteredTasinmazlar = filtered;
    this.currentPage = 1; // Filtreler uygulandƒ±ƒüƒ±nda sayfayƒ± sƒ±fƒ±rla
    this.updateMapFeatures();
  }

  /**
   * Filtreleri temizle
   */
  clearFilters(): void {
    this.filterSehir = '';
    this.filterIlce = '';
    this.filterMahalle = '';
    this.filterTasinmazTuru = '';
    this.filterParselNumarasi = '';
    this.filterPaftaNumarasi = '';
    this.filterAdres = '';
    this.filterKoordinat = '';
    this.filterAda = '';
    this.filteredTasinmazlar = [...this.tasinmazlar];
    this.currentPage = 1; // Filtreleri temizledikten sonra sayfayƒ± sƒ±fƒ±rla
    this.updateMapFeatures();
  }

  // Sayfalama i√ßin getter'lar ve metodlar
  get totalPages(): number {
    return Math.ceil(this.filteredTasinmazlar.length / this.itemsPerPage);
  }

  // ===== Map helpers =====
  private initMap(): void {
    const mapElement = document.getElementById('listMap');
    if (!mapElement || this.mapInitialized) {
      return;
    }

    try {
      this.listVectorSource = new VectorSource();
      this.listVectorLayer = new VectorLayer({
        source: this.listVectorSource,
        style: new Style({
          stroke: new Stroke({ color: '#3b82f6', width: 2 }),
          fill: new Fill({ color: 'rgba(59,130,246,0.15)' })
        })
      });

      this.listMap = new Map({
        target: 'listMap',
        layers: [
          new TileLayer({ source: new OSM() }),
          this.listVectorLayer
        ],
        view: new View({
          center: transform([35.0, 39.0], 'EPSG:4326', 'EPSG:3857'),
          zoom: 5
        })
      });

      this.mapInitialized = true;
      this.updateMapFeatures();
    } catch (e) {
      console.error('Liste haritasƒ± initialize edilemedi:', e);
    }
  }

  private updateMapFeatures(): void {
    if (!this.mapInitialized || !this.listVectorSource) return;
    this.listVectorSource.clear();

    const features: Feature[] = [];
    for (const t of this.filteredTasinmazlar) {
      if (!t.koordinat) continue;
      const polygon = this.parsePolygonFromCoordString(t.koordinat);
      if (polygon) {
        features.push(new Feature(polygon));
      }
    }

    if (features.length > 0) {
      this.listVectorSource.addFeatures(features);
      // fit view to features
      const extent = this.listVectorSource.getExtent();
      try {
        this.listMap.getView().fit(extent, { padding: [30, 30, 30, 30], maxZoom: 15, duration: 300 });
      } catch {}
    } else {
      // fallback center on TR
      this.listMap.getView().setCenter(transform([35.0, 39.0], 'EPSG:4326', 'EPSG:3857'));
      this.listMap.getView().setZoom(5);
    }
  }

  private parsePolygonFromCoordString(coordString: string): Polygon | null {
    try {
      const pairs = coordString.split(';').map(p => p.trim()).filter(Boolean);
      if (pairs.length < 3) return null;
      const coords = pairs.map(pair => {
        const [latStr, lngStr] = pair.split(',');
        const lat = Number(latStr);
        const lng = Number(lngStr);
        return [lng, lat] as [number, number];
      });
      if (coords[0][0] !== coords[coords.length - 1][0] || coords[0][1] !== coords[coords.length - 1][1]) {
        coords.push(coords[0]);
      }
      const webMercator = coords.map(c => transform(c, 'EPSG:4326', 'EPSG:3857')) as [number, number][];
      return new Polygon([webMercator]);
    } catch (e) {
      console.warn('Koordinat parse hatasƒ±:', e);
      return null;
    }
  }

  get paginatedTasinmazlar(): any[] {
    const startIndex = (this.currentPage - 1) * this.itemsPerPage;
    const endIndex = startIndex + this.itemsPerPage;
    return this.filteredTasinmazlar.slice(startIndex, endIndex);
  }

  goToPage(page: number): void {
    if (page >= 1 && page <= this.totalPages) {
      this.currentPage = page;
    }
  }

  getPagesArray(): number[] {
    const pages = [];
    for (let i = 1; i <= this.totalPages; i++) {
      pages.push(i);
    }
    return pages;
  }

  /**
   * Yeni bir ta≈üƒ±nmaz ekleme sayfasƒ±na y√∂nlendirir.
   */
  addTasinmaz(): void {
    this.router.navigate(['/tasinmaz-add']);
  }

  /**
   * Se√ßilen ta≈üƒ±nmazlarƒ± silmek i√ßin onay modalƒ±nƒ± a√ßar.
   */
  deleteSelectedTasinmazlar(): void {
    if (this.selectedTasinmazIds.length === 0) {
      return;
    }
    this.openModal(
      'Se√ßilen ' + this.selectedTasinmazIds.length + ' adet ta≈üƒ±nmazƒ± silmek istediƒüinizden emin misiniz?',
      () => this.onConfirmDeleteSelected()
    );
  }

  /**
   * Se√ßilen ta≈üƒ±nmazlarƒ± silme i≈ülemini ger√ßekle≈ütirir.
   */
  async onConfirmDeleteSelected(): Promise<void> {
    try {
      const deletePromises = this.selectedTasinmazIds.map(id => 
        firstValueFrom(this.tasinmazService.deleteTasinmaz(id))
      );

      await Promise.all(deletePromises);
      
      console.log('T√ºm se√ßilen ta≈üƒ±nmazlar ba≈üarƒ±yla silindi.');
      this.getTasinmazlar(); // Listeyi yenile
      this.selectedTasinmazIds = [];
      this.closeModal();
    } catch (error) {
      this.error = 'Ta≈üƒ±nmazlar silinirken bir hata olu≈ütu.';
      console.error('Silme hatasƒ±:', error);
      this.selectedTasinmazIds = [];
      this.closeModal();
    }
  }



  /**
   * Ta≈üƒ±nmaz d√ºzenleme sayfasƒ±na y√∂nlendirir.
   */
  editTasinmaz(id: number): void {
    this.router.navigate(['/tasinmaz-edit', id]);
  }



  /**
   * Checkbox se√ßimi deƒüi≈ütiƒüinde √ßalƒ±≈üƒ±r.
   */
  onCheckboxChange(id: number, event: any): void {
    if (event.target.checked) {
      this.selectedTasinmazIds.push(id);
    } else {
      this.selectedTasinmazIds = this.selectedTasinmazIds.filter(tasinmazId => tasinmazId !== id);
    }
  }

  /**
   * Hepsini se√ß/se√ßimi kaldƒ±r checkbox'ƒ± i√ßin.
   */
  toggleSelectAll(event: any): void {
    if (event.target.checked) {
      this.selectedTasinmazIds = this.tasinmazlar.map(tasinmaz => tasinmaz.id!);
    } else {
      this.selectedTasinmazIds = [];
    }
  }

  /**
   * Kullanƒ±cƒ± √ßƒ±kƒ±≈ü i≈ülemini yapar.
   */
  logout(): void {
    console.log('üö™ TasinmazList - Logout butonuna tƒ±klandƒ±');
    this.authService.logout();
    console.log('üîÑ TasinmazList - Login sayfasƒ±na y√∂nlendiriliyor...');
    
    // Router navigation dene, ba≈üarƒ±sƒ±z olursa window.location kullan
    this.router.navigate(['/login']).then(() => {
      console.log('‚úÖ TasinmazList - Login sayfasƒ±na ba≈üarƒ±yla y√∂nlendirildi');
    }).catch((error) => {
      console.error('‚ùå TasinmazList - Router navigation hatasƒ±:', error);
      console.log('üîÑ TasinmazList - Window.location ile y√∂nlendiriliyor...');
      window.location.href = '/login';
    });
  }

  /**
   * Modal pop-up a√ßar.
   */
  openModal(message: string, callback: Function): void {
    this.modalMessage = message;
    this.modalCallback = callback;
    this.showModal = true;
  }

  /**
   * Modal pop-up'ƒ± kapatƒ±r.
   */
  closeModal(): void {
    this.showModal = false;
    this.modalMessage = '';
    this.modalCallback = null;
  }

  /**
   * Modal'daki Tamam butonuna basƒ±ldƒ±ƒüƒ±nda callback'i √ßalƒ±≈ütƒ±rƒ±r.
   */
  confirmAction(): void {
    if (this.modalCallback) {
      this.modalCallback();
    }
  }

  /**
   * Ta≈üƒ±nmaz listesini Excel dosyasƒ±na aktarƒ±r.
   */
  exportToExcel(exportAll: boolean = true): void {
    console.log('üìä Ta≈üƒ±nmaz Excel export ba≈ülatƒ±lƒ±yor...', exportAll ? 'T√ºm√º' : 'Se√ßililer');

    let dataToExport: TasinmazListDto[] = [];

    if (exportAll) {
      if (this.filteredTasinmazlar.length === 0) {
        console.warn('Aktarƒ±lacak ta≈üƒ±nmaz kaydƒ± bulunmamaktadƒ±r.');
        return;
      }
      dataToExport = this.filteredTasinmazlar;
    } else {
      if (this.selectedTasinmazIds.length === 0) {
        console.warn('Aktarƒ±lacak se√ßili ta≈üƒ±nmaz kaydƒ± bulunmamaktadƒ±r.');
        return;
      }
      dataToExport = this.filteredTasinmazlar.filter(tasinmaz => this.selectedTasinmazIds.includes(tasinmaz.id!));
    }

    const data = dataToExport.map((tasinmaz, index) => ({
      'Sƒ±ra No': index + 1,
      'ID': tasinmaz.id,
      'Ada': tasinmaz.ada,
      'Parsel': tasinmaz.parsel,
      'Adres': tasinmaz.adres,
      'Koordinat': tasinmaz.koordinat,
      'Ta≈üƒ±nmaz Tipi': tasinmaz.tasinmazTipi || '-',
      'Mahalle ID': tasinmaz.mahalleId
    }));

    const ws: XLSX.WorkSheet = XLSX.utils.json_to_sheet(data);

    // S√ºtun geni≈üliklerini ayarla
    const columnWidths = [
      { wch: 8 },   // Sƒ±ra No
      { wch: 8 },   // ID
      { wch: 12 },  // Ada
      { wch: 12 },  // Parsel
      { wch: 40 },  // Adres
      { wch: 25 },  // Koordinat
      { wch: 15 },  // Ta≈üƒ±nmaz Tipi
      { wch: 12 }   // Mahalle ID
    ];
    ws['!cols'] = columnWidths;

    const wb: XLSX.WorkBook = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, 'Ta≈üƒ±nmazlar');

    const simdi = new Date();
    const tarih = this.datePipe.transform(simdi, 'dd-MM-yyyy');
    const saat = this.datePipe.transform(simdi, 'HH-mm-ss');
    const exportType = exportAll ? 'Tumunu' : 'Secili';
    const dosyaAdi = `Tasinmazlar_${exportType}_${tarih}_${saat}.xlsx`;

    XLSX.writeFile(wb, dosyaAdi);

    console.log(`‚úÖ Excel dosyasƒ± indirildi: ${dosyaAdi}`);
  }

  exportSelectedToExcel(): void {
    this.exportToExcel(false);
  }

  // ====== EXCEL IMPORT METODLARI ======
  
  /**
   * Excel dosyasƒ±ndan veri aktarƒ±r
   */
  importFromExcel(event: any): void {
    console.log('üì• Excel import ba≈ülatƒ±lƒ±yor...');
    
    const file = event.target.files[0];
    if (!file) {
      console.log('‚ö†Ô∏è Dosya se√ßilmedi');
      return;
    }

    // Dosya tipini kontrol et
    const validTypes = [
      'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet', // .xlsx
      'application/vnd.ms-excel', // .xls
      'application/vnd.ms-excel.sheet.macroEnabled.12' // .xlsm
    ];

    if (!validTypes.includes(file.type)) {
      this.error = 'L√ºtfen ge√ßerli bir Excel dosyasƒ± se√ßin (.xlsx, .xls)';
      console.error('‚ùå Ge√ßersiz dosya tipi:', file.type);
      // 5 saniye sonra error message'ƒ± temizle
      setTimeout(() => {
        this.error = null;
      }, 5000);
      return;
    }

    // Dosya boyutunu kontrol et (max 10MB)
    const maxSize = 10 * 1024 * 1024; // 10MB
    if (file.size > maxSize) {
      this.error = 'Dosya boyutu 10MB\'dan b√ºy√ºk olamaz';
      console.error('‚ùå Dosya boyutu √ßok b√ºy√ºk:', file.size);
      // 5 saniye sonra error message'ƒ± temizle
      setTimeout(() => {
        this.error = null;
      }, 5000);
      return;
    }

    console.log('‚úÖ Dosya se√ßildi:', file.name, 'Boyut:', file.size, 'Tip:', file.type);

    // FileReader ile dosyayƒ± oku
    const reader = new FileReader();
    reader.onload = (e: any) => {
      try {
        const data = new Uint8Array(e.target.result);
        const workbook = XLSX.read(data, { type: 'array' });
        
        console.log('üìä Excel workbook okundu, sheet sayƒ±sƒ±:', workbook.SheetNames.length);
        
        // ƒ∞lk sheet'i al
        const firstSheetName = workbook.SheetNames[0];
        const worksheet = workbook.Sheets[firstSheetName];
        
        console.log('üìã ƒ∞lk sheet:', firstSheetName);
        
        // JSON'a √ßevir
        const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
        
        console.log('üìã JSON verisi:', jsonData);
        
        // Veriyi i≈üle
        this.processExcelData(jsonData);
        
      } catch (error) {
        console.error('‚ùå Excel okuma hatasƒ±:', error);
        this.error = 'Excel dosyasƒ± okunamadƒ±: ' + (error as any).message;
        // 5 saniye sonra error message'ƒ± temizle
        setTimeout(() => {
          this.error = null;
        }, 5000);
      }
    };

    reader.onerror = () => {
      console.error('‚ùå Dosya okuma hatasƒ±');
      this.error = 'Dosya okunamadƒ±';
      // 5 saniye sonra error message'ƒ± temizle
      setTimeout(() => {
        this.error = null;
      }, 5000);
    };

    reader.readAsArrayBuffer(file);
  }

  /**
   * Excel verisini i≈üler ve ta≈üƒ±nmaz listesine ekler
   */
  private processExcelData(data: any[]): void {
    console.log('üîç Excel verisi i≈üleniyor...');
    
    if (data.length < 2) {
      this.error = 'Excel dosyasƒ± en az 2 satƒ±r i√ßermelidir (ba≈ülƒ±k + veri)';
      // 5 saniye sonra error message'ƒ± temizle
      setTimeout(() => {
        this.error = null;
      }, 5000);
      return;
    }

    // ƒ∞lk satƒ±r ba≈ülƒ±k olmalƒ±
    const headers = data[0] as string[];
    console.log('üìã Ba≈ülƒ±klar:', headers);

    // Gerekli kolonlarƒ± kontrol et
    const requiredColumns = ['ada', 'parsel', 'adres', 'koordinat', 'tasinmazTipi'];
    const missingColumns = requiredColumns.filter(col => 
      !headers.some(header => header?.toLowerCase().includes(col.toLowerCase()))
    );

    if (missingColumns.length > 0) {
      this.error = `Eksik kolonlar: ${missingColumns.join(', ')}`;
      console.error('‚ùå Eksik kolonlar:', missingColumns);
      // 5 saniye sonra error message'ƒ± temizle
      setTimeout(() => {
        this.error = null;
      }, 5000);
      return;
    }

    // Veri satƒ±rlarƒ±nƒ± i≈üle
    const newTasinmazlar: any[] = [];
    
    for (let i = 1; i < data.length; i++) {
      const row = data[i] as any[];
      if (row.length === 0 || !row.some(cell => cell)) continue; // Bo≈ü satƒ±rlarƒ± atla

      try {
        const tasinmaz = this.parseExcelRow(headers, row);
        if (tasinmaz) {
          newTasinmazlar.push(tasinmaz);
        }
      } catch (error) {
        console.error(`‚ùå Satƒ±r ${i + 1} i≈ülenirken hata:`, error);
      }
    }

    console.log('‚úÖ ƒ∞≈ülenen ta≈üƒ±nmaz sayƒ±sƒ±:', newTasinmazlar.length);

    if (newTasinmazlar.length > 0) {
      // Kullanƒ±cƒ±ya onay sor
      this.openModal(
        `${newTasinmazlar.length} adet ta≈üƒ±nmaz bulundu. Eklemek istiyor musunuz?`,
        () => this.addImportedTasinmazlar(newTasinmazlar)
      );
    } else {
      this.error = 'Excel dosyasƒ±ndan ge√ßerli veri bulunamadƒ±';
      // 5 saniye sonra error message'ƒ± temizle
      setTimeout(() => {
        this.error = null;
      }, 5000);
    }
  }

  /**
   * Excel satƒ±rƒ±nƒ± parse eder
   */
  private parseExcelRow(headers: string[], row: any[]): any | null {
    try {
      const tasinmaz: any = {};
      
      headers.forEach((header, index) => {
        if (header && row[index] !== undefined) {
          const value = row[index];
          
          // Header'ƒ± normalize et
          const normalizedHeader = header.toLowerCase().trim();
          
          if (normalizedHeader.includes('ada')) {
            tasinmaz.ada = String(value);
          } else if (normalizedHeader.includes('parsel')) {
            tasinmaz.parsel = String(value);
          } else if (normalizedHeader.includes('adres')) {
            tasinmaz.adres = String(value);
          } else if (normalizedHeader.includes('koordinat')) {
            tasinmaz.koordinat = String(value);
          } else if (normalizedHeader.includes('tasinmaz') || normalizedHeader.includes('tip')) {
            tasinmaz.tasinmazTipi = String(value);
          } else if (normalizedHeader.includes('mahalle')) {
            tasinmaz.mahalleId = Number(value) || null;
          }
        }
      });

      // Gerekli alanlarƒ± kontrol et
      if (!tasinmaz.ada || !tasinmaz.parsel || !tasinmaz.adres) {
        console.log('‚ö†Ô∏è Eksik gerekli alanlar, satƒ±r atlanƒ±yor');
        return null;
      }

      return tasinmaz;
    } catch (error) {
      console.error('‚ùå Satƒ±r parse hatasƒ±:', error);
      return null;
    }
  }

  /**
   * Import edilen ta≈üƒ±nmazlarƒ± veritabanƒ±na ekler
   */
  private async addImportedTasinmazlar(tasinmazlar: any[]): Promise<void> {
    console.log('üíæ Import edilen ta≈üƒ±nmazlar kaydediliyor...');
    
    this.loading = true;
    this.error = null;

    try {
      let successCount = 0;
      let errorCount = 0;

      for (const tasinmaz of tasinmazlar) {
        try {
          // Backend'e g√∂nder
          await firstValueFrom(this.tasinmazService.addTasinmaz(tasinmaz));
          successCount++;
          console.log('‚úÖ Ta≈üƒ±nmaz eklendi:', tasinmaz.ada, tasinmaz.parsel);
        } catch (error) {
          errorCount++;
          console.error('‚ùå Ta≈üƒ±nmaz eklenirken hata:', error);
        }
      }

      console.log(`‚úÖ Import tamamlandƒ±: ${successCount} ba≈üarƒ±lƒ±, ${errorCount} hatalƒ±`);
      
      if (successCount > 0) {
        this.successMessage = `${successCount} adet ta≈üƒ±nmaz ba≈üarƒ±yla eklendi`;
        // Listeyi yenile
        this.getTasinmazlar();
        
        // 5 saniye sonra success message'ƒ± temizle
        setTimeout(() => {
          this.successMessage = null;
        }, 5000);
      }
      
      if (errorCount > 0) {
        this.error = `${errorCount} adet ta≈üƒ±nmaz eklenirken hata olu≈ütu`;
        // 5 saniye sonra error message'ƒ± temizle
        setTimeout(() => {
          this.error = null;
        }, 5000);
      }

    } catch (error) {
      console.error('‚ùå Toplu ekleme hatasƒ±:', error);
      this.error = 'Ta≈üƒ±nmazlar eklenirken hata olu≈ütu: ' + (error as any).message;
      // 5 saniye sonra error message'ƒ± temizle
      setTimeout(() => {
        this.error = null;
      }, 5000);
    } finally {
      this.loading = false;
    }
  }

  // Navigasyon metodlarƒ±
  goBackToAdmin(): void {
    console.log('üîÑ Admin sayfasƒ±na y√∂nlendirme ba≈ülatƒ±lƒ±yor...');
    
    // Debug bilgileri
    console.log('üë§ Mevcut kullanƒ±cƒ± giri≈ü durumu:', this.authService.isLoggedIn());
    console.log('üè∑Ô∏è Kullanƒ±cƒ± rol√º:', this.authService.getUserRole());
    console.log('üó∫Ô∏è Mevcut URL:', window.location.pathname);
    console.log('üéØ Hedef URL: /admin-dashboard');
    
    // √ñnce Angular Router ile dene
    this.router.navigate(['/admin-dashboard'])
      .then((success) => {
        if (success) {
          console.log('‚úÖ Router ile admin sayfasƒ±na ba≈üarƒ±yla y√∂nlendirildi');
        } else {
          console.log('‚ö†Ô∏è Router ba≈üarƒ±sƒ±z, window.location ile deneniyor...');
          // Router ba≈üarƒ±sƒ±z olursa window.location kullan
          window.location.href = '/admin-dashboard';
        }
      })
      .catch((error) => {
        console.error('‚ùå Router hatasƒ±:', error);
        console.log('üîÑ Fallback: window.location kullanƒ±lƒ±yor...');
        // Hata durumunda window.location kullan
        window.location.href = '/admin-dashboard';
      });
  }
}
